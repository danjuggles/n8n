name: Redeploy Portainer (via Tailscale)
on:
  push:
    branches: [ main ]   # change if needed

jobs:
  redeploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Join your tailnet temporarily using an ephemeral auth key
      - name: Connect to Tailscale (ephemeral)
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      - name: Trigger Portainer webhook (with API key)
        env:
          PORTAINER_BASE: "http://100.71.26.31:9000"
          # PORTAINER_BASE: "https://nas.your-tailnet.ts.net:9443"
          WEBHOOK_PATH: "api/webhooks/c87dbb65-d991-4892-959b-91947dd1c4ef"
          PORTAINER_KEY: ${{ secrets.PORTAINER_API_KEY }}
        run: |
          set -euo pipefail
          curl -fsSL -X POST \
            -H "X-API-Key: $PORTAINER_KEY" \
            "$PORTAINER_BASE/$WEBHOOK_PATH"
